# Ansible
Данный проект предназначен для установки, настройки и обновления конфигураций HAProxy, Envoy, Keepalived, Docker, iptables и timeout ssh.

Поддерживаемый функционал:
1. **HAProxy**: установка, настройка и обновление конфигураций.
2. **Envoy**: установка, настройка и обновление конфигураций.
3. **Keepalived**: установка, настройка и обновление конфигурации.
4. **Docker**: установка и настройка.
5. **IPtables**: настройка и обновление конфигурации.
6. **Timeout**: настройка времени ssh сессии в 180 минут.

Ansible inventory генерируется на основе кластеров k8s описанных в yaml файлах в директории K8S_INFRA (название yaml файла соответствует название кластера, для удобства) и файла actions.yaml в котором задается выбор исполняемых плейбуков и узлов.

В файле actions.yaml перечислены все исполняемые ансиблом плейбуки, в которые можно добавить узлы на которых они буду выполняться.
В нем можно указывать, как сами узлы и группы узлов на которых будут выполняться плейбуки, так и значение `all`, если что-то нужно выполнить на всех кластерах, узлах кластера или узлах определенных групп.

Пример:
```
docker:
  k8s-prod:
    - k8s-prod-m1.local
    - k8s-prod-w2.local
  k8s-test:
    k8s-masters:
      - all
    k8s-workers:
      - all

envoy:
  k8s-prod:
    load-balancers:
      - all

haproxy:
  k8s-test:
    - k8s-lb-1.local
    - k8s-lb-2.local

iptables:
  k8s-prod:
    k8s-masters:
      - all
    k8s-workers:
      - k8s-prod-w2.local

keepalived:
  k8s-test:
    - k8s-lb-1.local
    - k8s-lb-2.local

timeout:
  - all
```
Пояснение:
- **Docker** будет установлен и настроен на двух узлах кластера k8s-prod (k8s-prod-m1.local и k8s-prod-w2.local), а так же на всех мастерах и воркерах кластера k8s-test (всех описанных в файле k8s-test.yaml в директории K8S_INFRA).
- **Envoy** будет развернут и сконфигурирован на всех балансировщиках кластера k8s-prod, в конфигурация будет настроена в соответствие с описанными узлами кластер в файле k8s-prod.yaml в директории K8S_INFRA. т.е. будет предоставлен доступ по порту 6443 до всех мастеров и 80/443 до воркер нод данного кластера.
- **HAProxy** будет установлен и настроен аналогично Envoy, только для кластера k8s-test.
- **iptables** пропишет правила iptables для всех мастеров кластера k8s-prod и воркер ноды k8s-prod-w2.local, в них будут входить все узлы описанные в файле k8s-prod.yaml (разрешит весь входящий трафик между узлами кластера)
- **Keepalived** будет установлен и сконфигурирован на балансровщиках кластера k8s-test и его vip адрес будет взят из описания кластера (cluster-vip), virtual_router_id будет сгенерирован случайным образом в диапазоне 150-250.
- **timeout** на всех кластерах и их узлых в описанных в файлах директории K8S_INFRA, будет выставлено времени ssh сессии в 180 минут.

Yaml файл описывающий кластер k8s состоит из vip адреса кластера(точки входа трафика), балансировщиков, мастеров и воркеров.
```
cluster-vip:
  - 192.168.1.220

load-balancers:
  - k8s-lb-1.local
  - k8s-lb-2.local

k8s-masters:
  - k8s-test-m1.local

k8s-workers:
  - k8s-test-w1.local
  - k8s-test-w2.local
```